<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Show do Crent√£o</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg:#000; --panel:#0b0f0e; --panel-2:#0f1413; --stroke:rgba(255,255,255,.06);
      --white:#fff; --muted:#aab3b1;
      --green:#16a34a; --green-700:#0f7a39; --red:#dc2626; --red-700:#b91c1c;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.45);
      --pad: clamp(14px, 3vw, 26px); --maxw: 1060px;
      --opt:#111619; --opt-hover:#182023; --opt-selected:#0f2e21; --opt-confirm:#14532d; --opt-wrong:#4a1d1d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    img{display:block;max-width:100%}
    .hidden{display:none !important}
    .muted{color:var(--muted)}

    header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 var(--pad); z-index:40;
      background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));
    }
    .brand img{height:22px; opacity:.95}
    .title-logo{height:24px; opacity:.95; display:none}

    main{display:grid; gap:18px; padding:72px var(--pad) 40px; max-width:var(--maxw); margin:0 auto}

    .card{
      background:rgba(12,15,15,.78); backdrop-filter: blur(6px);
      border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding: min(28px, 3.2vw);
    }
    h1,h2{margin:0 0 10px}
    h2{font-size:22px}
    .sub{margin:0 0 14px; font-size:14px; color:#a7b1af}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.right{justify-content:flex-end}

    .btn{
      appearance:none; border:0; border-radius:14px; padding:12px 18px;
      font-weight:800; letter-spacing:.02em; cursor:pointer; box-shadow:var(--shadow);
      background:#fff; color:#0a0d0c;
      transition: transform .08s ease, box-shadow .2s ease, opacity .2s ease, filter .2s ease;
    }
    .btn:active{transform: translateY(1px)}
    .btn.green{ background:linear-gradient(180deg, var(--green) 0%, var(--green-700) 100%); color:#e8f5ee }
    .btn.red{ background:linear-gradient(180deg, var(--red) 0%, var(--red-700) 100%); color:#fff }
    .btn.pill{ border-radius:999px; background:#141a19; color:#e6ffef; border:1px solid rgba(255,255,255,.08) }
    .btn.pill:hover{ background:#18211f }

    /* QUIZ */
    #quizCard .topline{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;
    }
    #questionText{font-size:22px; font-weight:800; margin:0 0 6px}
    #ladderText{font-size:13px; color:#98a3a0}

    #options{ display:grid; gap:10px; margin:8px 0 18px; }
    .opt{
      display:flex; align-items:center; gap:12px; padding:14px 16px;
      background:var(--opt); border:1px solid rgba(255,255,255,.06); border-radius:12px;
      cursor:pointer; user-select:none;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .opt:hover{ background:var(--opt-hover) }
    .opt input{ display:none }
    .opt .badge{ width:26px; height:26px; display:grid; place-items:center;
      border-radius:999px; background:#1f2937; font-weight:800; font-size:12px; }
    .opt.selected{ background:var(--opt-selected); border-color:rgba(22,163,74,.6) }
    .opt.confirm{ background:var(--opt-confirm); border-color:rgba(22,163,74,.9) }
    .opt.wrong{ background:var(--opt-wrong); border-color:rgba(220,38,38,.8) }

    /* Lifelines embaixo, como no Show do Milh√£o */
    #lifelines{ display:flex; gap:10px; flex-wrap:wrap; margin:2px 0 14px }
    #lifelines .btn{ padding:10px 14px }

    /* Confirm modal */
    .confirm-box{ margin-top:4px; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:#0a0f0f; }
    .confirm-title{ font-weight:800; margin-bottom:8px }

    /* Final */
    .final-title{font-size:22px; font-weight:800; margin:0 0 8px}
    .final-msg{color:#cbd6d4; margin:0 0 12px}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/logo.png" alt="Sobrenatural Church" onerror="this.style.display='none'">
  </div>
  <img id="crentaoLogo" class="title-logo" src="img/logosc.png" alt="Show do Crent√£o" onerror="this.style.display='none'">
</header>

<main>

  <!-- QUIZ CARD -->
  <section id="quizCard" class="card">
    <div class="topline">
      <div>
        <h2 id="questionText">Pergunta</h2>
        <p id="ladderText" class="sub"></p>
      </div>
    </div>

    <div id="options"></div>

    <!-- Lifelines embaixo -->
    <div id="lifelines" class="row">
      <button id="btnUni"  class="btn pill">üéì Universit√°rios</button>
      <button id="btnCartas" class="btn pill">üÇ† Cartas</button>
      <button id="btnAssist" class="btn pill">ü§ñ Assistente</button>
      <button id="btnPular" class="btn pill">üèÉ Pular</button>
    </div>

    <!-- A√ß√µes -->
    <div class="row">
      <button id="btnEnviar" class="btn green">Enviar</button>
      <button id="btnPararAgora" class="btn red">Parar</button>
    </div>

    <!-- Confirma√ß√£o -->
    <div id="confirmBox" class="confirm-box hidden">
      <div class="confirm-title">Voc√™ tem certeza da resposta?</div>
      <div class="row">
        <button id="btnConfirmar" class="btn green">Sim</button>
        <button id="btnCancelar" class="btn">N√£o</button>
      </div>
    </div>

    <!-- P√≥s acerto: parar ou continuar -->
    <div id="posAcertoBox" class="confirm-box hidden">
      <div class="confirm-title" id="posAcertoTitulo"></div>
      <div class="row">
        <button id="btnParar" class="btn">Parar agora</button>
        <button id="btnContinuar" class="btn green">Continuar</button>
      </div>
    </div>

    <!-- √Åudios -->
    <audio id="fxCerteza"      src="audio/silvio-santos-voce-tem-certeza.mp3" preload="auto"></audio>
    <audio id="fxEntendeu"     src="audio/silvio-santos-voce-entendeu-a-pergunta.mp3" preload="auto"></audio>
    <audio id="fxEstaCerto"    src="audio/silvio-santos-esta-certo-disso.mp3" preload="auto"></audio>
    <audio id="fxQualResposta" src="audio/silvio-santos-qual-e-a-resposta-certa.mp3" preload="auto"></audio>
    <audio id="fxCerta"        src="audio/silvio-santos-certa-resposta.mp3" preload="auto"></audio>
    <audio id="fxErrou"        src="audio/faustao-errou.mp3" preload="auto"></audio>
    <audio id="fxAbertura"     src="audio/silvio-santos-abertura-show-do-milhao.mp3" preload="auto" loop></audio>
  </section>

  <!-- TELA FINAL -->
  <section id="section-final" class="card hidden">
    <h2 class="final-title" id="finalTitulo">Fim do jogo</h2>
    <p class="final-msg" id="finalMsg"></p>
    <div class="row" style="margin-top:10px">
      <a class="btn" href="ranking.html">Ver ranking</a>
    </div>
  </section>

</main>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
(function(){
  /* ---------- Supabase ---------- */
  const SUPABASE_URL = import.meta?.env?.VITE_SUPABASE_URL || 'https://ihajmegcdgwchxslnaep.supabase.co';
  const SUPABASE_ANON_KEY = import.meta?.env?.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImloYWptZWdjZGd3Y2h4c2xuYWVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTQzMTgsImV4cCI6MjA3MjA3MDMxOH0.WM36lA9n0PU9qd-DKdrWVB_UzGVXpsfJ984oHiXDU8Y';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ---------- Refs ---------- */
  const crentaoLogo = document.getElementById('crentaoLogo');
  const fxAbertura     = document.getElementById('fxAbertura');
  const fxCerteza      = document.getElementById('fxCerteza');
  const fxEntendeu     = document.getElementById('fxEntendeu');
  const fxEstaCerto    = document.getElementById('fxEstaCerto');
  const fxQualResposta = document.getElementById('fxQualResposta');
  const fxCerta        = document.getElementById('fxCerta');
  const fxErrou        = document.getElementById('fxErrou');

  const questionText = document.getElementById('questionText');
  const ladderText   = document.getElementById('ladderText');
  const optionsBox   = document.getElementById('options');

  const btnUni       = document.getElementById('btnUni');
  const btnCartas    = document.getElementById('btnCartas');
  const btnAssist    = document.getElementById('btnAssist');
  const btnPular     = document.getElementById('btnPular');

  const btnEnviar    = document.getElementById('btnEnviar');
  const btnPararAgora= document.getElementById('btnPararAgora');

  const confirmBox   = document.getElementById('confirmBox');
  const btnConfirmar = document.getElementById('btnConfirmar');
  const btnCancelar  = document.getElementById('btnCancelar');

  const posBox       = document.getElementById('posAcertoBox');
  const posTitulo    = document.getElementById('posAcertoTitulo');
  const btnParar     = document.getElementById('btnParar');
  const btnContinuar = document.getElementById('btnContinuar');

  const secFinal     = document.getElementById('section-final');
  const finalTitulo  = document.getElementById('finalTitulo');
  const finalMsg     = document.getElementById('finalMsg');

  const canPlay = a => { try { a.currentTime=0; a.play().catch(()=>{}); } catch(e){} };
  const stop = a => { try { a.pause(); a.currentTime=0; } catch(e){} };

  /* ---------- Jogo ---------- */
  const ladder=[100,200,300,500,1000,2000,5000,10000,20000,50000,100000,200000,300000,500000,750000,1000000];
  const safeIdx=new Set([4,9,14]); // 5/10/15

  let perguntas=[], pool={facil:[], medio:[], dificil:[]};
  let idx=0, escolha=null, acertos=0;
  const lifelines={uni:true, cartas:true, assist:true, skip:true};

  /* Fallback simples */
  const FALLBACK_RAW=[
    {enunciado:'Qual √© o prop√≥sito original do crist√£o segundo o discipulado?', a:'Ensinar', b:'Servir', c:'Cantar', d:'Jejuar', correta:'B', dificuldade:'facil'},
    {enunciado:'Quem √© o maior exemplo de servo na Terra?', a:'Mois√©s', b:'Davi', c:'Jesus', d:'Paulo', correta:'C', dificuldade:'facil'},
    {enunciado:'Complete: ‚ÄúServir √© para pessoas ___‚Äù.', a:'Orgulhosas', b:'Imaturas', c:'Santas', d:'Maduras', correta:'D', dificuldade:'facil'},
    {enunciado:'O que significa ‚Äúobedi√™ncia imediata‚Äù?', a:'Esperar confirma√ß√µes', b:'Fazer parcialmente', c:'Responder sem demora', d:'Obedecer quando conveniente', correta:'C', dificuldade:'medio'},
    {enunciado:'Cora√ß√£o de servo revela:', a:'Cumprir escala', b:'Tarefa como fim', c:'Aben√ßoar pessoas atrav√©s da tarefa', d:'Fazer s√≥ o combinado', correta:'C', dificuldade:'dificil'},
  ];

  function normalizaPergunta(row, idx){
    const mapLetra={A:0,B:1,C:2,D:3};
    const certaIndex = mapLetra[(row.correta||'').toUpperCase()];
    let dif = (row.dificuldade || '').toString().toLowerCase();
    if (!['facil','medio','dificil'].includes(dif)) dif = 'dificil';
    return {
      id: row.id ?? ('local_'+idx+'_'+Date.now()),
      enunciado: row.enunciado,
      opcoes: [row.a,row.b,row.c,row.d],
      certa: certaIndex,
      dificuldade: dif
    };
  }

  function embaralhar(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a; }
  function pickFrom(arr){ return arr.splice(Math.floor(Math.random()*arr.length),1)[0]; }
  function takeN(poolArr, n){ const out=[]; for(let i=0;i<n && poolArr.length;i++){ out.push(pickFrom(poolArr)); } return out; }

  function montarSequencia(todas){
    pool={facil:[], medio:[], dificil:[]};
    todas.forEach(q=>{
      const d=q.dificuldade==='facil'?'facil':(q.dificuldade==='medio'?'medio':'dificil');
      pool[d].push(q);
    });
    pool.facil=embaralhar(pool.facil); pool.medio=embaralhar(pool.medio); pool.dificil=embaralhar(pool.dificil);
    const seq=[...takeN(pool.facil,3), ...takeN(pool.medio,3), ...takeN(pool.dificil,10)];
    const restantes=[...pool.facil,...pool.medio,...pool.dificil];
    while(seq.length<16 && restantes.length){ seq.push(pickFrom(restantes)); }
    const usados=new Set(seq.map(q=>q.id));
    pool.facil = pool.facil.filter(q=>!usados.has(q.id));
    pool.medio = pool.medio.filter(q=>!usados.has(q.id));
    pool.dificil = pool.dificil.filter(q=>!usados.has(q.id));
    return seq.slice(0,16);
  }

  async function buscarPerguntas(){
    try{
      const { data, error } = await sb.from('perguntas')
        .select('id,enunciado,a,b,c,d,correta,dificuldade')
        .order('id',{ascending:true})
        .limit(400);
      if(error) throw error;
      if(!data || !data.length) throw new Error('Sem perguntas');
      const todas = data.map(normalizaPergunta).filter(q => q.certa>=0 && q.opcoes.every(Boolean));
      if(!todas.length) throw new Error('Perguntas inv√°lidas');
      return montarSequencia(todas);
    }catch(e){
      console.warn('Falha ao buscar perguntas do Supabase, usando fallback.', e);
      const fb = FALLBACK_RAW.map(normalizaPergunta);
      return montarSequencia(fb);
    }
  }

  function setLifelineButtons(){
    btnUni.disabled=!lifelines.uni;   btnUni.style.opacity=lifelines.uni?1:.5;
    btnCartas.disabled=!lifelines.cartas; btnCartas.style.opacity=lifelines.cartas?1:.5;
    btnAssist.disabled=!lifelines.assist; btnAssist.style.opacity=lifelines.assist?1:.5;
    btnPular.disabled=!lifelines.skip; btnPular.style.opacity=lifelines.skip?1:.5;
  }

  function renderPergunta(){
    const p=perguntas[idx];
    questionText.textContent = p.enunciado;
    ladderText.textContent   = `Vale ${ladder[idx].toLocaleString('pt-BR')} talento(s) de sabedoria`;

    optionsBox.innerHTML='';
    p.opcoes.forEach((txt,i)=>{
      const el=document.createElement('label');
      el.className='opt';
      el.innerHTML = `<input type="radio" name="op" value="${i}"><span class="badge">${'ABCD'[i]}</span><span>${txt}</span>`;
      el.addEventListener('click', ()=>{
        document.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected'); escolha=i;
      });
      optionsBox.appendChild(el);
    });

    escolha=null; setLifelineButtons();
    confirmBox.classList.add('hidden'); posBox.classList.add('hidden');
    canPlay(fxEntendeu);
  }

  function acumuladoAtual(){ return acertos>0 ? ladder[acertos-1] : 0; }
  function calculaCheckpoint(){
    if (acertos===0) return 0;
    if (acertos===perguntas.length) return ladder[ladder.length-1];
    let premio=0; for (let i=0;i<acertos;i++){ if(safeIdx.has(i)) premio=ladder[i]; }
    return premio;
  }

  async function finalizar({parouAgora=false, parouDepois=false, errou=false}){
    let tesouro=0;
    if (parouAgora) tesouro = acumuladoAtual();
    else if (parouDepois) tesouro = ladder[idx];
    else if (errou) tesouro = calculaCheckpoint();
    else tesouro = ladder[ladder.length-1];

    try{
      const payload = { nome: 'An√¥nimo', fone: null, pontos: acertos, tesouro, quando: new Date().toISOString() };
      await sb.from('ranking').insert([payload]);
    }catch(e){ console.warn('Erro ao gravar ranking:', e); }

    document.getElementById('quizCard').classList.add('hidden');
    secFinal.classList.remove('hidden');
    if(errou){ finalTitulo.textContent='N√£o foi dessa vez üòÖ'; finalMsg.textContent=`Voc√™ terminou com ${tesouro.toLocaleString('pt-BR')} talento(s).`; }
    else if(parouDepois || parouAgora){ finalTitulo.textContent='Voc√™ decidiu parar üëè'; finalMsg.textContent=`Garantiu ${tesouro.toLocaleString('pt-BR')} talento(s).`; }
    else { finalTitulo.textContent='Concluiu todas! üèÜ'; finalMsg.textContent=`Pontua√ß√£o m√°xima: ${tesouro.toLocaleString('pt-BR')} talento(s).`; }
  }

  // A√ß√µes
  btnEnviar.addEventListener('click', ()=>{
    if(escolha===null){ canPlay(fxCerteza); return; }
    confirmBox.classList.remove('hidden'); posBox.classList.add('hidden');
    stop(fxEntendeu); canPlay([fxCerteza,fxEstaCerto,fxQualResposta][idx % 3]);
  });

  btnCancelar.addEventListener('click', ()=> confirmBox.classList.add('hidden'));

  btnConfirmar.addEventListener('click', async ()=>{
    confirmBox.classList.add('hidden');
    const correta = (escolha===perguntas[idx].certa);
    document.querySelectorAll('.opt').forEach((el,i)=>{
      el.classList.remove('selected');
      if (i===perguntas[idx].certa) el.classList.add('confirm');
      if (i===escolha && !correta) el.classList.add('wrong');
    });

    if(correta){
      acertos++; await new Promise(r=>{canPlay(fxCerta); setTimeout(r,700);});
      posTitulo.textContent = `Acertou! Voc√™ j√° tem ${ladder[idx].toLocaleString('pt-BR')} talento(s). Deseja PARAR agora ou CONTINUAR?`;
      posBox.classList.remove('hidden');
      btnParar.onclick = ()=> finalizar({parouDepois:true});
      btnContinuar.onclick = ()=>{
        idx++; if(idx<perguntas.length) renderPergunta(); else finalizar({});
      };
    }else{
      canPlay(fxErrou);
      setTimeout(()=>finalizar({errou:true}), 900);
    }
  });

  btnPararAgora.addEventListener('click', ()=>{
    if(!confirm('Deseja encerrar agora e ficar com o valor acumulado at√© aqui?')) return;
    finalizar({parouAgora:true});
  });

  // Lifelines (placeholders simples)
  btnUni.addEventListener('click', ()=>{
    if(!lifelines.uni) return; lifelines.uni=false; setLifelineButtons();
    alert('Universit√°rios opinam‚Ä¶ (implementa√ß√£o visual entra na pr√≥xima etapa)');
  });
  btnCartas.addEventListener('click', ()=>{
    if(!lifelines.cartas) return; lifelines.cartas=false; setLifelineButtons();
    alert('Cartas: elimina 0/1/2/3 alternativas conforme a carta (entra na pr√≥xima etapa).');
  });
  btnAssist.addEventListener('click', ()=>{
    if(!lifelines.assist) return; lifelines.assist=false; setLifelineButtons();
    const c = perguntas[idx].certa;
    alert('Assistente: a correta √© ' + 'ABCD'[c]);
  });
  btnPular.addEventListener('click', ()=>{
    if(!lifelines.skip) return;
    const atual = perguntas[idx]; const diff = atual.dificuldade;
    const repositorio = pool[diff] || []; if(!repositorio.length){ alert('N√£o h√° pergunta extra deste n√≠vel para pular.'); return; }
    lifelines.skip=false; setLifelineButtons();
    perguntas[idx] = repositorio.splice(Math.floor(Math.random()*repositorio.length),1)[0];
    renderPergunta(); canPlay(fxEntendeu);
  });

  // Start
  (async ()=>{
    crentaoLogo.style.display=''; // tenta mostrar logo do topo
    canPlay(fxAbertura);
    perguntas = await buscarPerguntas();
    idx=0; escolha=null; acertos=0;
    lifelines.uni=true; lifelines.cartas=true; lifelines.assist=true; lifelines.skip=true;
    renderPergunta();
  })();

})();
</script>
</body>
</html>



